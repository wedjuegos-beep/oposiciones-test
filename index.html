<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Oposiciones Test</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
      authDomain: "oposiciones-test.firebaseapp.com",
      projectId: "oposiciones-test",
      storageBucket: "oposiciones-test.firebasestorage.app",
      messagingSenderId: "116305102438",
      appId: "1:116305102438:web:25684cd6467f5a27398fa7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let preguntasActuales = [];

    // Login
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("login").style.display = "none";
        document.getElementById("usuario").textContent = user.displayName;
        document.getElementById("panel").style.display = "block";
      }
    });

    window.login = function () {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider);
    };

    // Empezar test
    window.empezarTest = async function (tema) {
      const oposicion = document.getElementById("oposicion").value;

      const q = query(
        collection(db, "questions"),
        where("oposicion", "==", oposicion),
        where("tema", "==", tema)
      );

      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        alert("No hay preguntas para este tema");
        return;
      }

      preguntasActuales = [];
      snapshot.forEach(doc => preguntasActuales.push(doc.data()));

      mostrarTest();
    };

    function mostrarTest() {
      const contenedor = document.getElementById("test");
      contenedor.innerHTML = "";

      preguntasActuales.forEach((p, i) => {
        const preguntaDiv = document.createElement("div");
        preguntaDiv.className = "pregunta";

        let html = `<p><strong>${i + 1}. ${p.pregunta}</strong></p>`;
        p.opciones.forEach((op, idx) => {
          html += `<button class="opcion" data-index="${idx}" data-pregunta="${i}">${op}</button>`;
        });

        preguntaDiv.innerHTML = html;
        contenedor.appendChild(preguntaDiv);
      });

      const botonCorregir = document.createElement("button");
      botonCorregir.textContent = "Corregir Test";
      botonCorregir.onclick = corregirTest;
      botonCorregir.className = "corregir";
      contenedor.appendChild(botonCorregir);
    }

    function corregirTest() {
      let aciertos = 0;
      const resultadoDiv = document.getElementById("test");
      const botones = resultadoDiv.querySelectorAll(".opcion");

      botones.forEach(btn => {
        const i = parseInt(btn.dataset.pregunta);
        const idx = parseInt(btn.dataset.index);
        btn.classList.remove("correcta", "incorrecta");
        const seleccionada = document.querySelector(`.opcion[data-pregunta='${i}'].seleccionada`);
        if (seleccionada && parseInt(seleccionada.dataset.index) === preguntasActuales[i].correcta) {
          aciertos++;
        }
      });

      let htmlResultado = `<p><strong>${aciertos} / ${preguntasActuales.length}</strong></p>`;
      preguntasActuales.forEach((p, i) => {
        const seleccion = document.querySelector(`.opcion[data-pregunta='${i}'].seleccionada`);
        if (!seleccion || parseInt(seleccion.dataset.index) !== p.correcta) {
          htmlResultado += `
            <p>
              ‚ùå ${p.pregunta}<br>
              ‚úÖ Respuesta correcta: ${p.opciones[p.correcta]}<br>
              üß† ${p.explicacion}
            </p>
          `;
        }
      });

      resultadoDiv.innerHTML = htmlResultado;
    }

    // Marcar bot√≥n seleccionado
    window.addEventListener("click", e => {
      if (e.target.classList.contains("opcion")) {
        const siblings = e.target.parentNode.querySelectorAll(".opcion");
        siblings.forEach(sib => sib.classList.remove("seleccionada"));
        e.target.classList.add("seleccionada");
      }
    });
  </script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; }
    header { background:#2c3e50; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:24px; }
    button { cursor:pointer; padding:8px 15px; margin:5px; border:none; border-radius:5px; }
    #panel { padding:20px; }
    select { padding:5px; margin-bottom:15px; }
    #temas { display:flex; gap:10px; flex-wrap:wrap; }
    #temas button { background:#3498db; color:white; flex:1 0 120px; }
    #test { margin-top:20px; background:white; padding:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
    .pregunta { margin-bottom:15px; }
    .opcion { display:block; width:100%; text-align:left; background:#ecf0f1; margin:3px 0; }
    .opcion.seleccionada { background:#f1c40f; }
    .corregir { background:#27ae60; color:white; margin-top:10px; }
  </style>
</head>

<body>
  <header>
    <h1>Oposiciones Test</h1>
    <div id="login"><button onclick="login()">Login con Google</button></div>
    <div id="usuario" style="display:inline;"></div>
  </header>

  <div id="panel" style="display:none;">
    <h3>Selecciona oposici√≥n</h3>
    <select id="oposicion">
      <option value="TAI">T√©cnico Auxiliar de Inform√°tica</option>
      <option value="Administrativo">Administrativo</option>
    </select>

    <h3>Selecciona tema</h3>
    <div id="temas">
      <button onclick="empezarTest('tema1')">Tema 1</button>
      <button onclick="empezarTest('tema2')">Tema 2</button>
      <button onclick="empezarTest('tema3')">Tema 3</button>
    </div>

    <div id="test"></div>
  </div>
</body>
</html>
