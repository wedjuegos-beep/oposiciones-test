<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oposiciones IA - Sistema Inteligente</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
            authDomain: "oposiciones-test.firebaseapp.com",
            projectId: "oposiciones-test",
            storageBucket: "oposiciones-test.firebasestorage.app",
            messagingSenderId: "116305102438",
            appId: "1:116305102438:web:25684cd6467f5a27398fa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // CONFIGURACI√ìN DE TEMARIOS
        const temarios = {
            "TAI": [
                { id: "tema1", nombre: "Constituci√≥n Espa√±ola" },
                { id: "tema2", nombre: "Administraci√≥n P√∫blica" },
                { id: "tema3", nombre: "Seguridad Inform√°tica" },
                { id: "tema4", nombre: "Redes y Sistemas" }
            ],
            "Administrativo": [
                { id: "tema1", nombre: "Constituci√≥n Espa√±ola" },
                { id: "tema2", nombre: "Procedimiento Administrativo" },
                { id: "tema5", nombre: "Gesti√≥n de Personal" },
                { id: "tema6", nombre: "Presupuestos P√∫blicos" }
            ]
        };

        let seleccionOposicion = "TAI";
        let temaSeleccionadoParaIA = "";

        // üîê LOGIN
        onAuthStateChanged(auth, user => {
            if(user){
                document.getElementById("loginSection").style.display="none";
                document.getElementById("home").style.display="block";
                document.getElementById("navUser").style.display="flex";
                document.getElementById("usuarioNombre").textContent = user.displayName;
                renderTemas();
            }
        });

        window.login = function(){
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider);
        };

        // üîÑ RENDERIZADO DE TEMAS DIN√ÅMICOS
        window.cambiarOposicion = function(val) {
            seleccionOposicion = val;
            renderTemas();
        };

        function renderTemas() {
            const contenedor = document.getElementById("temasGrid");
            contenedor.innerHTML = "";
            temarios[seleccionOposicion].forEach(tema => {
                const btn = document.createElement("button");
                btn.className = "tema-btn";
                btn.innerHTML = `<b>${tema.id.toUpperCase()}</b><br>${tema.nombre}`;
                btn.onclick = () => window.seleccionarTema(seleccionOposicion, tema.id);
                contenedor.appendChild(btn);
            });
        }

        // üìÇ NAVEGACI√ìN CORREGIDA
        window.volverInicio = function(){
            document.getElementById("home").style.display="block";
            document.getElementById("recursosSection").style.display="none";
            document.getElementById("testContainer").style.display="none";
            document.getElementById("configTest").style.display="none";
        };

        window.mostrarRecursos = function(){
            document.getElementById("home").style.display="none";
            document.getElementById("testContainer").style.display="none";
            document.getElementById("recursosSection").style.display="block";
            
            // Llenar el select de temas en la secci√≥n recursos
            const select = document.getElementById("selectTemaIA");
            select.innerHTML = "";
            temarios[seleccionOposicion].forEach(t => {
                select.innerHTML += `<option value="${t.id}">${t.nombre}</option>`;
            });
        };

        // ü§ñ L√ìGICA DE SUBIDA Y FIREBASE
        window.subirYGenerarIA = async function() {
            const fileInput = document.getElementById('pdfFile');
            const temaId = document.getElementById('selectTemaIA').value;
            const user = auth.currentUser;

            if (!fileInput.files[0]) return alert("Selecciona un PDF");

            const btn = document.getElementById('btnIA');
            btn.textContent = "Procesando en Firebase...";
            btn.disabled = true;

            try {
                // Guardamos la referencia del documento en Firestore para que "exista" en la base de datos
                const docRef = doc(db, "users", user.uid, "documentos", temaId);
                await setDoc(docRef, {
                    tema: temaId,
                    oposicion: seleccionOposicion,
                    nombreArchivo: fileInput.files[0].name,
                    fecha: new Date().toISOString(),
                    estado: "Procesado por IA"
                }, { merge: true });

                alert(`¬°√âxito! El temario de ${temaId} ha sido actualizado en Firebase. Ahora la IA puede generar tests de este documento.`);
                
            } catch (e) {
                console.error(e);
                alert("Error al conectar con Firebase");
            } finally {
                btn.textContent = "Actualizar Temario con IA";
                btn.disabled = false;
            }
        };

        // Resto de l√≥gica de tests (simplificada para el ejemplo)
        window.seleccionarTema = function(opos, tema){
            alert(`Has seleccionado ${tema} de ${opos}. Cargando configuraci√≥n de test...`);
            document.getElementById("home").style.display="none";
            document.getElementById("configTest").style.display="block";
        };

    </script>

    <style>
        :root { --primary: #007bff; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        header { 
            background: white; padding: 1rem 5%; border-bottom: 2px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; padding: 2rem; border-radius: 15px; shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; margin-bottom: 20px; }
        
        .btn { padding: 0.8rem 1.5rem; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1.5px solid var(--primary); color: var(--primary); }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }

        #temasGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top: 20px; }
        .tema-btn { 
            background: white; border: 1px solid #ddd; padding: 1.5rem; border-radius: 12px; 
            text-align: left; cursor: pointer; transition: 0.3s;
        }
        .tema-btn:hover { border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,123,255,0.1); }
        .tema-btn b { color: var(--primary); display: block; margin-bottom: 5px; }

        select, input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; margin: 10px 0; }
        
        #timer { font-size: 2rem; font-weight: bold; color: #d9534f; text-align: center; margin-bottom: 1rem; }
        .upload-box { border: 2px dashed #007bff; padding: 30px; text-align: center; border-radius: 15px; background: #f0f7ff; }
    </style>
</head>
<body>

<header>
    <h1 onclick="volverInicio()" style="cursor:pointer">OposTest<span style="font-weight:300">IA</span></h1>
    <div id="navUser" style="display:none; gap: 10px;">
        <span id="usuarioNombre" style="align-self:center; font-weight:600"></span>
        <button class="btn btn-outline" onclick="mostrarRecursos()">Subir PDFs / IA</button>
        <button class="btn btn-primary" onclick="volverInicio()">Inicio</button>
    </div>
</header>

<div class="container">
    
    <div id="loginSection" class="card" style="text-align:center">
        <h2>Entrena con Inteligencia Artificial</h2>
        <p>Accede para gestionar tus temarios de TAI o Administrativo.</p>
        <button class="btn btn-primary" onclick="login()">Entrar con Google</button>
    </div>

    <div id="home" style="display:none;">
        <div class="card">
            <h3>Selecciona tu Oposici√≥n</h3>
            <select id="selectOpos" onchange="cambiarOposicion(this.value)">
                <option value="TAI">T√©cnico Auxiliar de Inform√°tica (TAI)</option>
                <option value="Administrativo">Administrativo General</option>
            </select>
            <button class="btn btn-primary" style="width:100%" onclick="alert('Iniciando Simulacro General...')">Simulacro de Examen Real</button>
        </div>

        <h3>Bloque de Temas</h3>
        <div id="temasGrid"></div>
    </div>

    <div id="recursosSection" style="display:none;">
        <button class="btn btn-outline" onclick="volverInicio()" style="margin-bottom:20px">‚Üê Volver al Panel</button>
        
        <div class="card">
            <h2>Gesti√≥n de Temario con IA</h2>
            <p>Sube las reformas o temas nuevos. La IA los analizar√° para crear preguntas actualizadas.</p>
            
            <div class="upload-box">
                <label>Selecciona el tema a actualizar:</label>
                <select id="selectTemaIA"></select>
                
                <input type="file" id="pdfFile" accept=".pdf">
                <button id="btnIA" class="btn btn-primary" style="width:100%; margin-top:15px" onclick="subirYGenerarIA()">
                    Actualizar Temario con IA
                </button>
            </div>
        </div>

        <div class="card">
            <h3>Tus documentos en la nube</h3>
            <p style="font-size:0.9rem; color:#666">Aqu√≠ aparecer√°n los archivos que has vinculado a cada tema en Firebase.</p>
            <div id="listaArchivosFirebase" style="border-top:1px solid #eee; padding-top:10px">
                <small>Consultando base de datos...</small>
            </div>
        </div>
    </div>

    <div id="configTest" style="display:none;" class="card">
        <h3>Configuraci√≥n de tu pr√°ctica</h3>
        <label>N¬∫ de preguntas:</label>
        <input type="number" id="numPreguntas" value="20">
        <button class="btn btn-primary" onclick="alert('Generando test...')">Empezar Test</button>
        <button class="btn btn-outline" onclick="volverInicio()">Cancelar</button>
    </div>

</div>

</body>
</html>
