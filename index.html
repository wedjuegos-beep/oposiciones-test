<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OposTest IA - Sistema de Drive</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
            authDomain: "oposiciones-test.firebaseapp.com",
            projectId: "oposiciones-test",
            storageBucket: "oposiciones-test.firebasestorage.app",
            messagingSenderId: "116305102438",
            appId: "1:116305102438:web:25684cd6467f5a27398fa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // TEMARIO OFICIAL TAI (15 TEMAS)
        const oposData = {
            "TAI": { 
                nombre: "T√©cnico Auxiliar Inform√°tica", 
                temas: [
                    "Tema 1: Constituci√≥n Espa√±ola", "Tema 2: Administraci√≥n AGE", "Tema 3: Uni√≥n Europea",
                    "Tema 4: Gobierno y Administraci√≥n", "Tema 5: Admin. Electr√≥nica", "Tema 6: Inform√°tica B√°sica",
                    "Tema 7: Sistemas Operativos", "Tema 8: Windows y Linux", "Tema 9: Redes",
                    "Tema 10: Seguridad Inform√°tica", "Tema 11: Ofim√°tica", "Tema 12: Correo y Colaboraci√≥n",
                    "Tema 13: Bases de Datos", "Tema 14: Programaci√≥n", "Tema 15: Gesti√≥n de Sistemas"
                ]
            }
        };

        let userActual = null;
        let oposSel = null;
        let temasSeleccionados = [];

        window.mostrarVista = (id) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
            document.getElementById("navApp").style.display = (oposSel) ? "flex" : "none";
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userActual = user;
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if (uDoc.exists() && uDoc.data().oposicion) {
                    window.seleccionarOposicion(uDoc.data().oposicion);
                } else { mostrarVista('vistaSeleccion'); }
            } else { mostrarVista('vistaLogin'); }
        });

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());

        window.seleccionarOposicion = async (key) => {
            oposSel = key;
            await setDoc(doc(db, "users", userActual.uid), { oposicion: key }, { merge: true });
            document.getElementById("txtOposHeader").textContent = oposData[key].nombre;
            actualizarTemarioYDrive();
            mostrarVista('vistaPanel');
        };

        // RENDERIZA TEMAS Y COMPRUEBA EN DRIVE SI TIENEN ENLACE
        async function actualizarTemarioYDrive() {
            const grid = document.getElementById("containerTemas");
            const select = document.getElementById("selectTemaDrive");
            grid.innerHTML = ""; select.innerHTML = "";
            
            // Traemos los recursos que el usuario ya ha vinculado
            const q = query(collection(db, "recursos_drive"), where("uid", "==", userActual.uid));
            const snapshot = await getDocs(q);
            const recursosGuardados = {};
            snapshot.forEach(doc => { recursosGuardados[doc.data().tema] = doc.data().url; });

            oposData[oposSel].temas.forEach((t) => {
                const tieneArchivo = recursosGuardados[t];
                const card = document.createElement("div");
                card.className = `card-tema ${tieneArchivo ? 'con-archivo' : ''}`;
                card.innerHTML = `
                    <h4>${t}</h4>
                    <p>${tieneArchivo ? '‚úÖ PDF Vinculado' : '‚ùå Sin PDF'}</p>
                    ${tieneArchivo ? `<button class="btn-mini" onclick="window.open('${tieneArchivo}', '_blank')">Ver en Drive</button>` : ''}
                `;
                card.onclick = (e) => {
                    if(e.target.tagName === 'BUTTON') return;
                    card.classList.toggle("selected");
                    if(card.classList.contains("selected")) temasSeleccionados.push(t);
                    else temasSeleccionados = temasSeleccionados.filter(i => i !== t);
                };
                grid.appendChild(card);
                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        // VINCULAR ENLACE DE DRIVE
        window.vincularEnlaceDrive = async () => {
            const url = document.getElementById("inputUrlDrive").value;
            const tema = document.getElementById("selectTemaDrive").value;
            if(!url.includes("drive.google.com")) return alert("Introduce un enlace v√°lido de Google Drive");

            await addDoc(collection(db, "recursos_drive"), {
                uid: userActual.uid,
                tema: tema,
                url: url,
                fecha: new Date()
            });
            alert("Tema vinculado correctamente");
            actualizarTemarioYDrive();
        };

        window.generarTest = (tipo) => {
            const chatBox = document.getElementById("chatBox");
            if (tipo === 'manual' && temasSeleccionados.length === 0) return alert("Selecciona temas primero");
            
            chatBox.innerHTML = `<div class="msg">ü§ñ <b>IA:</b> Analizando tus carpetas en Drive para el simulacro <b>${tipo}</b>. Generando preguntas de examen real...</div>`;
        };

    </script>

    <style>
        :root { --p: #2563eb; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }
        header { background: white; padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .content { flex: 1; overflow-y: auto; padding: 20px; }
        .view { display: none; flex-direction: column; width: 100%; max-width: 900px; margin: 0 auto; }
        .grid-temas { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; width: 100%; }
        .card-tema { background: white; padding: 15px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-tema.selected { border-color: var(--p); background: #eff6ff; }
        .card-tema.con-archivo { border-left: 5px solid #10b981; }
        .btn { background: var(--p); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px; }
        .btn-mini { font-size: 0.7rem; background: #e2e8f0; border: none; padding: 5px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        #chatLateral { width: 320px; background: white; border-left: 2px solid #e2e8f0; display: flex; flex-direction: column; }
        .msg { background: #f1f5f9; padding: 12px; border-radius: 10px; margin-bottom: 10px; font-size: 0.9rem; }
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 100%; margin: 10px 0; }
    </style>
</head>
<body>

<header>
    <h2>OposTest IA</h2>
    <span id="txtOposHeader" style="font-weight:bold; color:var(--p)"></span>
    <div id="navApp" style="display:none;">
        <button class="btn" onclick="mostrarVista('vistaPanel')">Panel</button>
        <button class="btn" onclick="mostrarVista('vistaBiblioteca')">Mi Drive</button>
    </div>
</header>

<div class="main-layout">
    <div class="content">
        <div id="vistaLogin" class="view" style="align-items:center; justify-content:center; height:100%;">
            <button class="btn" onclick="login()">Entrar con Google</button>
        </div>

        <div id="vistaSeleccion" class="view">
            <h2>Elige tu Oposici√≥n</h2>
            <button class="btn" onclick="seleccionarOposicion('TAI')">T√©cnico Auxiliar Inform√°tica (TAI)</button>
        </div>

        <div id="vistaPanel" class="view">
            <div style="margin-bottom: 25px;">
                <h3>Simulacros de Examen</h3>
                <button class="btn" style="background:#059669" onclick="generarTest('TOTAL')">üî• Examen Real (Total)</button>
                <button class="btn" onclick="generarTest('MANUAL')">üéØ Test Temas Seleccionados</button>
            </div>
            <h3>Temario TAI</h3>
            <div id="containerTemas" class="grid-temas"></div>
        </div>

        <div id="vistaBiblioteca" class="view">
            <div style="background:white; padding:30px; border-radius:15px; width:100%; max-width:500px; margin: 0 auto;">
                <h3>üìÇ Vincular Recursos de Drive</h3>
                <p>Copia el enlace de "Compartir" de tu archivo PDF en Drive y as√≠gnalo a un tema.</p>
                
                <label>Selecciona el Tema:</label>
                <select id="selectTemaDrive"></select>
                
                <label>Enlace de Drive:</label>
                <input type="text" id="inputUrlDrive" placeholder="https://drive.google.com/...">
                
                <button class="btn" style="width:100%" onclick="vincularEnlaceDrive()">Vincular Documento</button>
                
                <div style="margin-top:20px; font-size:0.8rem; color:#666;">
                    * Aseg√∫rate de que el enlace sea "Cualquier persona con el enlace puede leer".
                </div>
            </div>
        </div>
    </div>

    <div id="chatLateral">
        <div style="background:var(--p); color:white; padding:15px; font-weight:bold;">ü§ñ IA Tutor</div>
        <div id="chatBox" style="flex:1; padding:15px; overflow-y:auto;">
            <div class="msg">Hola! He detectado que ya tienes temas en tu Drive. Selecciona los que quieras repasar y generar√© un test basado en tus PDFs.</div>
        </div>
        <div style="padding:10px; border-top:1px solid #eee;">
            <input type="text" placeholder="Haz una pregunta sobre el temario..." style="width:100%; padding:10px; border-radius:5px; border:1px solid #ddd;">
        </div>
    </div>
</div>

</body>
</html>
