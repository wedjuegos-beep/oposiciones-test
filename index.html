<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OposTest IA - Sistema Corregido</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
            authDomain: "oposiciones-test.firebaseapp.com",
            projectId: "oposiciones-test",
            storageBucket: "oposiciones-test.firebasestorage.app",
            messagingSenderId: "116305102438",
            appId: "1:116305102438:web:25684cd6467f5a27398fa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userActual = null;
        let oposSel = null;
        let temasSeleccionados = [];

        // --- GESTIN DE CLAVE ---
        window.configurarLlave = () => {
            const key = prompt("Pega aqu铆 la clave que copiaste de AI Studio:");
            if (key) { localStorage.setItem("OPOS_IA_KEY", key.trim()); location.reload(); }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userActual = user;
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if (uDoc.exists() && uDoc.data().oposicion) seleccionarOposicion(uDoc.data().oposicion);
                else mostrarVista('vistaSeleccion');
            } else { mostrarVista('vistaLogin'); }
        });

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());
        
        window.mostrarVista = (id) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        };

        const oposData = {
            "TAI": ["Constituci贸n", "AGE", "UE", "Inform谩tica B谩sica", "Redes", "Seguridad"],
            "AUX_VALENCIA": ["Constituci贸n", "Org. Municipal", "Proc. Administrativo", "Haciendas Locales"]
        };

        window.seleccionarOposicion = async (key) => {
            oposSel = key;
            await setDoc(doc(db, "users", userActual.uid), { oposicion: key }, { merge: true });
            renderizarTemas();
            mostrarVista('vistaPanel');
            document.getElementById("nav").style.display = "block";
        };

        function renderizarTemas() {
            const container = document.getElementById("temas");
            container.innerHTML = "";
            oposData[oposSel].forEach(t => {
                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = t;
                div.onclick = () => {
                    div.classList.toggle("selected");
                    if(div.classList.contains("selected")) temasSeleccionados.push(t);
                    else temasSeleccionados = temasSeleccionados.filter(item => item !== t);
                };
                container.appendChild(div);
            });
        }

        // --- GENERADOR DE TEST ---
        window.generarTestIA = async () => {
            const key = localStorage.getItem("OPOS_IA_KEY");
            if (!key) return configurarLlave();
            
            const chat = document.getElementById("chat");
            chat.innerHTML = "Generando preguntas...";

            // Probamos la ruta m谩s compatible para gemini 1.5 flash
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{parts: [{text: `Crea un test de 3 preguntas para la oposici贸n ${oposSel} sobre: ${temasSeleccionados.join(", ")}`}]}]
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error.message);
                chat.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, "<br>");
            } catch (e) {
                chat.innerHTML = "Error: " + e.message + "<br><button onclick='configurarLlave()'>Revisar Clave</button>";
            }
        };
    </script>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; background: #f4f4f4; }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .sidebar { width: 300px; background: white; border-left: 1px solid #ddd; padding: 20px; }
        .card { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; cursor: pointer; border: 1px solid #ccc; }
        .selected { border-left: 5px solid orange; background: #fff9f0; }
        .view { display: none; }
        .btn { background: orange; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="content">
    <div id="nav" style="display:none; margin-bottom:20px;">
        <button onclick="mostrarVista('vistaSeleccion')">Cambiar Oposici贸n</button>
        <button onclick="configurarLlave()"> Clave IA</button>
    </div>

    <div id="vistaLogin" class="view">
        <h1>OposTest</h1>
        <button class="btn" onclick="login()">Entrar con Google</button>
    </div>

    <div id="vistaSeleccion" class="view">
        <h2>Elige Oposici贸n</h2>
        <button onclick="seleccionarOposicion('TAI')">TAI</button>
        <button onclick="seleccionarOposicion('AUX_VALENCIA')">Valencia</button>
    </div>

    <div id="vistaPanel" class="view">
        <button class="btn" onclick="generarTestIA()">Generar Test</button>
        <div id="temas"></div>
    </div>
</div>

<div class="sidebar">
    <h3>Resultado Test</h3>
    <div id="chat">Selecciona temas y pulsa generar.</div>
</div>

</body>
</html>
