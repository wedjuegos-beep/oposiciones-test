<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OposTest IA - Estado y GVA</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // CONFIG FIREBASE (Tus datos originales)
        const firebaseConfig = {
            apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
            authDomain: "oposiciones-test.firebaseapp.com",
            projectId: "oposiciones-test",
            storageBucket: "oposiciones-test.firebasestorage.app",
            messagingSenderId: "116305102438",
            appId: "1:116305102438:web:25684cd6467f5a27398fa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // TEMARIOS OFICIALES ACTUALIZADOS
        const oposiciones = {
            "TAI_ESTADO": [
                { bloque: "I. Organizaci√≥n del Estado", temas: ["Constituci√≥n Espa√±ola", "Cortes Generales", "El Gobierno", "Administraci√≥n P√∫blica"] },
                { bloque: "II. Tecnolog√≠a de la Informaci√≥n", temas: ["Hardware", "Sistemas Operativos", "Redes", "Seguridad Inform√°tica"] },
                { bloque: "III. Desarrollo de Sistemas", temas: ["Bases de Datos", "Algoritmos", "Lenguajes de Programaci√≥n"] }
            ],
            "AUX_ESTADO": [
                { bloque: "I. Organizaci√≥n P√∫blica", temas: ["Constituci√≥n", "Tribunal Constitucional", "Pol√≠ticas de Igualdad", "Transparencia"] },
                { bloque: "II. Actividad Administrativa", temas: ["Procedimiento Administrativo", "R√©gimen Jur√≠dico", "Documentaci√≥n", "Atenci√≥n al Ciudadano"] },
                { bloque: "III. Gesti√≥n de Recursos", temas: ["Personal Funcionario", "Seguridad Social", "Presupuestos P√∫blicos"] }
            ],
            "AUX_GVA": [
                { bloque: "I. Derecho Constitucional y GVA", temas: ["Estatuto de Autonom√≠a CV", "Les Corts", "El Consell", "La Generalitat"] },
                { bloque: "II. Funci√≥n P√∫blica Valenciana", temas: ["Ley de Funci√≥n P√∫blica GVA", "Derechos y Deberes", "Carrera Profesional"] },
                { bloque: "III. Temas Espec√≠ficos GVA", temas: ["Hacienda P√∫blica Valenciana", "Uni√≥n Europea", "Administraci√≥n Electr√≥nica GVA"] }
            ]
        };

        let oposicionActual = "";

        onAuthStateChanged(auth, user => {
            if(user){
                document.getElementById("loginSection").style.display="none";
                document.getElementById("navUser").style.display="flex";
                document.getElementById("usuarioNombre").textContent = user.displayName;
                document.getElementById("seleccionInicial").style.display="block";
            }
        });

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());

        // Funci√≥n para renderizar temas al elegir oposicion
        window.seleccionarOposicion = function(tipo) {
            oposicionActual = tipo;
            const container = document.getElementById("temarioDinamico");
            container.innerHTML = "";
            const titulos = { "TAI_ESTADO": "TAI (Estado)", "AUX_ESTADO": "Auxiliar Administrativo (Estado)", "AUX_GVA": "Auxiliar Administrativo (GVA)" };
            document.getElementById("tituloOpos").textContent = titulos[tipo];

            oposiciones[tipo].forEach(bloque => {
                let html = `<div class="bloque-card"><h4>${bloque.bloque}</h4><div class="grid-temas">`;
                bloque.temas.forEach(tema => {
                    html += `<button class="tema-btn" onclick="prepararTest('${tema}')">${tema}</button>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });
            
            document.getElementById("seleccionInicial").style.display = "none";
            document.getElementById("panelTemas").style.display = "block";
        };

        // L√≥gica de navegaci√≥n corregida
        window.volverInicio = () => {
            document.getElementById("panelTemas").style.display = "none";
            document.getElementById("recursosSection").style.display = "none";
            document.getElementById("seleccionInicial").style.display = "block";
        };

        window.mostrarRecursos = () => {
            document.getElementById("panelTemas").style.display = "none";
            document.getElementById("seleccionInicial").style.display = "none";
            document.getElementById("recursosSection").style.display = "block";
            
            // Resetear el selector de temas de recursos
            actualizarTemasRecursos("TAI_ESTADO");
        };

        window.actualizarTemasRecursos = (opos) => {
            const select = document.getElementById("selectTemaIA");
            select.innerHTML = "";
            oposiciones[opos].forEach(b => {
                b.temas.forEach(t => select.innerHTML += `<option value="${t}">${t}</option>`);
            });
        };

        window.triggerFileInput = () => document.getElementById('pdfFile').click();

        window.subirPDF = async () => {
            const file = document.getElementById('pdfFile').files[0];
            const opos = document.getElementById("selectOposIA").value;
            const tema = document.getElementById('selectTemaIA').value;
            if(!file) return alert("Por favor, selecciona un PDF");

            const btn = document.getElementById("btnSubir");
            btn.textContent = "Procesando en Firebase...";
            btn.disabled = true;

            try {
                // Registro en Firestore vinculado al usuario y el tema espec√≠fico [cite: 21]
                await setDoc(doc(db, "recursos", `${auth.currentUser.uid}_${tema}`), {
                    usuario: auth.currentUser.uid,
                    oposicion: opos,
                    tema: tema,
                    nombreArchivo: file.name,
                    fecha: new Date().toLocaleDateString(),
                    timestamp: new Date().getTime()
                });
                alert(`PDF de "${tema}" registrado. La IA ya puede generar preguntas de este material.`);
                window.volverInicio();
            } catch (e) {
                alert("Error al guardar en base de datos");
            } finally {
                btn.textContent = "Confirmar y Analizar";
                btn.disabled = false;
            }
        };

        window.prepararTest = (tema) => alert("Cargando test generado por IA para: " + tema);

    </script>

    <style>
        :root { --blue: #0056b3; --success: #28a745; --bg: #f4f7f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: #333; }
        
        header { background: white; padding: 15px 5%; border-bottom: 2px solid #e1e4e8; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        header h1 { color: var(--blue); margin: 0; font-size: 1.5rem; cursor: pointer; }

        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        
        /* Oposiciones Cards */
        .selector-opos { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        .card-choice { background: white; padding: 30px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; border: 2px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-choice:hover { border-color: var(--blue); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card-choice h3 { margin: 10px 0; color: var(--blue); }

        /* Bloques de Temas */
        .bloque-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid var(--blue); }
        .bloque-card h4 { margin-top: 0; color: var(--blue); border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .grid-temas { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
        .tema-btn { background: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .tema-btn:hover { background: var(--blue); color: white; border-color: var(--blue); }

        /* Estilo Botones y Formularios */
        .btn-main { background: var(--blue); color: white; padding: 12px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-nav { background: white; border: 1.5px solid #ddd; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .upload-section { background: white; padding: 40px; border-radius: 15px; border: 2px dashed #cbd5e0; text-align: center; }
        
        select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e0; margin-bottom: 20px; background: white; font-size: 1rem; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <h1 onclick="window.volverInicio()">OposTest<span style="font-weight:300">IA</span></h1>
    <div id="navUser" style="display:none; gap: 15px;">
        <span id="usuarioNombre" style="align-self:center; font-weight:600"></span>
        <button class="btn-nav" onclick="mostrarRecursos()">üìÅ Mis Recursos / IA</button>
        <button class="btn-main" onclick="volverInicio()">Ir al Inicio</button>
    </div>
</header>

<div class="container">
    <div id="loginSection" style="text-align:center; margin-top:80px;">
        <div style="background:white; padding:50px; border-radius:20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05);">
            <h2 style="color:var(--blue)">Tu Academia Inteligente</h2>
            <p>Accede para practicar con tests generados por IA del temario oficial.</p>
            <button class="btn-main" style="padding:15px 40px; font-size:1.1rem;" onclick="login()">Iniciar con Google</button>
        </div>
    </div>

    <div id="seleccionInicial" style="display:none;">
        <h2 style="text-align:center; margin-bottom:40px;">Selecciona tu Oposici√≥n</h2>
        <div class="selector-opos">
            <div class="card-choice" onclick="seleccionarOposicion('TAI_ESTADO')">
                <h3>TAI (Estado)</h3>
                <p>T√©cnico Auxiliar de Inform√°tica</p>
            </div>
            <div class="card-choice" onclick="seleccionarOposicion('AUX_ESTADO')">
                <h3>Auxiliar (Estado)</h3>
                <p>Cuerpo Auxiliar Administrativo</p>
            </div>
            <div class="card-choice" onclick="seleccionarOposicion('AUX_GVA')">
                <h3>Auxiliar (GVA)</h3>
                <p>Administrativo Generalitat Valenciana</p>
            </div>
        </div>
    </div>

    <div id="panelTemas" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h2 id="tituloOpos" style="margin:0"></h2>
            <button class="btn-nav" onclick="volverInicio()">‚Üê Cambiar Oposici√≥n</button>
        </div>
        <div id="temarioDinamico"></div>
    </div>

    <div id="recursosSection" style="display:none;">
        <div class="upload-section">
            <h2 style="color:var(--blue)">Generador de Test por PDF</h2>
            <p style="margin-bottom:30px">Sube tus apuntes para que la IA los analice y cree preguntas nuevas.</p>
            
            <div style="text-align:left; max-width:600px; margin: 0 auto;">
                <label><b>1. Elige la oposici√≥n:</b></label>
                <select id="selectOposIA" onchange="actualizarTemasRecursos(this.value)">
                    <option value="TAI_ESTADO">TAI (Estado)</option>
                    <option value="AUX_ESTADO">Auxiliar Administrativo (Estado)</option>
                    <option value="AUX_GVA">Auxiliar Administrativo (GVA)</option>
                </select>

                <label><b>2. Elige el tema para este PDF:</b></label>
                <select id="selectTemaIA"></select>
                
                <div style="text-align:center; padding:20px; border: 1px solid #e1e4e8; border-radius:12px; margin-bottom:20px;">
                    <input type="file" id="pdfFile" class="hidden" accept=".pdf">
                    <button class="btn-nav" style="border-color:var(--success); color:var(--success)" onclick="triggerFileInput()">üìÅ Seleccionar Archivo PDF</button>
                    <p id="fileNameDisplay" style="margin-top:10px; font-size:0.9rem; color:#666">Ning√∫n archivo seleccionado</p>
                </div>
            </div>
            
            <button id="btnSubir" class="btn-main" style="width:100%; max-width:600px; background:var(--success)" onclick="subirPDF()">Confirmar y Analizar con IA</button>
        </div>
    </div>
</div>

<script>
    // Peque√±o script para mostrar el nombre del archivo seleccionado
    document.getElementById('pdfFile').addEventListener('change', function() {
        document.getElementById('fileNameDisplay').textContent = this.files[0] ? this.files[0].name : "Ning√∫n archivo seleccionado";
    });
</script>

</body>
</html>
