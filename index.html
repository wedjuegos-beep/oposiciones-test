<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Oposiciones Test</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { 
  getFirestore, collection, query, where, getDocs,
  doc, setDoc, getDoc, updateDoc, arrayUnion, addDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ðŸ”§ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
  authDomain: "oposiciones-test.firebaseapp.com",
  projectId: "oposiciones-test",
  storageBucket: "oposiciones-test.firebasestorage.app",
  messagingSenderId: "116305102438",
  appId: "1:116305102438:web:25684cd6467f5a27398fa7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= ESTADO ================= */
let preguntasActuales = [];
let seleccionOposicion = "";
let seleccionTema = "";

/* ================= LOGIN ================= */
onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById("login").style.display="none";
    document.getElementById("usuario").textContent=user.displayName;
    mostrar("home");
  }
});

window.login = () => signInWithPopup(auth, new GoogleAuthProvider());

/* ================= NAVEGACIÃ“N ================= */
function ocultarTodo(){
  ["home","configTest","configSimulacion","testContainer","recursos"]
  .forEach(id => document.getElementById(id).style.display="none");
}
function mostrar(id){
  ocultarTodo();
  document.getElementById(id).style.display="block";
}
window.volverInicio = () => mostrar("home");
window.mostrarRecursos = () => mostrar("recursos");

/* ================= HOME ================= */
window.seleccionarTema = (opos,tema) => {
  seleccionOposicion = opos;
  seleccionTema = tema;
  mostrar("configTest");
};

/* ================== RECURSOS ================== */

// Extraer texto del PDF
async function extraerTextoPDF(file){
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument(buffer).promise;
  let texto = "";

  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    texto += content.items.map(i=>i.str).join(" ");
  }
  return texto;
}

// Subir PDF a Firestore
window.subirPDF = async () => {
  const file = document.getElementById("pdfRec").files[0];
  if(!file){ alert("Selecciona un PDF"); return; }

  const texto = await extraerTextoPDF(file);

  await addDoc(collection(db,"resources"),{
    oposicion: document.getElementById("opRec").value,
    tema: document.getElementById("temaRec").value,
    titulo: file.name,
    textoPlano: texto,
    fecha: new Date()
  });

  alert("PDF subido correctamente");
};

// BotÃ³n IA (todavÃ­a vacÃ­o)
window.generarPreguntasIA = () => {
  alert("En el siguiente paso conectaremos aquÃ­ la IA ðŸ¤–");
};
</script>

<style>
body{font-family:Arial;background:#f4f4f4;margin:0}
header{background:#2c3e50;color:white;padding:10px;display:flex;justify-content:space-between}
button{margin:4px;padding:6px}
.card{background:white;padding:10px;border-radius:5px;margin:5px}
</style>
</head>

<body>

<header>
  <div>
    <button onclick="volverInicio()">Home</button>
    <button onclick="mostrarRecursos()">Recursos</button>
  </div>
  <div>
    <span id="usuario"></span>
    <button id="login" onclick="login()">Login</button>
  </div>
</header>

<!-- HOME -->
<div id="home" style="display:none;padding:20px">
  <h2>TAI</h2>
  <button onclick="seleccionarTema('TAI','tema1')">Tema 1</button>
  <button onclick="seleccionarTema('TAI','tema2')">Tema 2</button>
</div>

<!-- CONFIG TEST (sin tocar) -->
<div id="configTest" style="display:none;padding:20px">
  <p>AquÃ­ sigue tu test normal (no tocado)</p>
  <button onclick="volverInicio()">Volver</button>
</div>

<!-- RECURSOS -->
<div id="recursos" style="display:none;padding:20px">
  <h3>Subir temario PDF</h3>

  <select id="opRec">
    <option value="TAI">TAI</option>
    <option value="Administrativo">Administrativo</option>
  </select><br><br>

  <input id="temaRec" placeholder="tema1"><br><br>
  <input type="file" id="pdfRec" accept="application/pdf"><br><br>

  <button onclick="subirPDF()">ðŸ“„ Subir PDF</button>
  <hr>
  <button onclick="generarPreguntasIA()">ðŸ¤– Generar preguntas con IA</button>
</div>

</body>
</html>
