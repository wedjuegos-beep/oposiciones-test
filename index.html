<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OposTest IA - Versi√≥n Estable</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
            authDomain: "oposiciones-test.firebaseapp.com",
            projectId: "oposiciones-test",
            storageBucket: "oposiciones-test.firebasestorage.app",
            messagingSenderId: "116305102438",
            appId: "1:116305102438:web:25684cd6467f5a27398fa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const oposData = {
            "TAI": { nombre: "T√©cnico Auxiliar Inform√°tica", temas: ["Tema 1: Constituci√≥n", "Tema 2: AGE", "Tema 3: Uni√≥n Europea", "Tema 4: Gobierno", "Tema 5: Admin. Electr√≥nica", "Tema 6: Inform√°tica B√°sica", "Tema 7: Sistemas Operativos", "Tema 8: Windows/Linux", "Tema 9: Redes", "Tema 10: Seguridad", "Tema 11: Ofim√°tica", "Tema 12: Correo", "Tema 13: BBDD", "Tema 14: Programaci√≥n", "Tema 15: Gesti√≥n"] },
            "AUX_ESTADO": { nombre: "Auxiliar Estado", temas: ["Bloque I", "Bloque II"] }
        };

        let userActual = null;
        let oposSel = null;
        let temasSeleccionados = [];

        window.mostrarVista = (id) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
            document.getElementById("navApp").style.display = (oposSel) ? "flex" : "none";
            if(oposSel) document.getElementById("chatLateral").style.display = "flex";
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userActual = user;
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if (uDoc.exists() && uDoc.data().oposicion) {
                    window.seleccionarOposicion(uDoc.data().oposicion);
                } else { mostrarVista('vistaSeleccion'); }
            } else { mostrarVista('vistaLogin'); }
        });

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());
        
        // Funci√≥n corregida para cambiar oposici√≥n
        window.irASeleccion = () => {
            oposSel = null;
            mostrarVista('vistaSeleccion');
        };

        window.seleccionarOposicion = async (key) => {
            oposSel = key;
            try {
                await setDoc(doc(db, "users", userActual.uid), { oposicion: key }, { merge: true });
                document.getElementById("txtOposHeader").textContent = oposData[key].nombre;
                renderizarTodo();
                mostrarVista('vistaPanel');
            } catch (e) { alert("Error de permisos en Firestore. Revisa la pesta√±a Rules."); }
        };

        async function renderizarTodo() {
            const grid = document.getElementById("containerTemas");
            const select = document.getElementById("selectTemaDrive");
            grid.innerHTML = ""; select.innerHTML = "";
            
            const q = query(collection(db, "recursos_drive"), where("uid", "==", userActual.uid), where("oposicion", "==", oposSel));
            const snap = await getDocs(q);
            const vinculados = {};
            snap.forEach(d => { vinculados[d.data().tema] = d.data().url; });

            oposData[oposSel].temas.forEach(t => {
                const card = document.createElement("div");
                card.className = `card-tema ${vinculados[t] ? 'check' : ''}`;
                card.innerHTML = `<h4>${t}</h4><small>${vinculados[t] ? '‚úÖ Vinculado' : '‚ùå Sin archivo'}</small>`;
                card.onclick = () => {
                    card.classList.toggle("selected");
                    if(card.classList.contains("selected")) temasSeleccionados.push(t);
                    else temasSeleccionados = temasSeleccionados.filter(i => i !== t);
                };
                grid.appendChild(card);
                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        window.vincularDrive = async () => {
            const url = document.getElementById("inputUrl").value;
            const tema = document.getElementById("selectTemaDrive").value;
            if(!url.includes("drive.google.com")) return alert("Enlace no v√°lido");
            
            await addDoc(collection(db, "recursos_drive"), {
                uid: userActual.uid,
                oposicion: oposSel,
                tema: tema,
                url: url
            });
            alert("Vinculado!");
            renderizarTodo();
        };

        // Simulaci√≥n de IA que responde
        window.enviarDuda = () => {
            const p = document.getElementById("inputChat").value;
            const box = document.getElementById("chatBox");
            if(!p) return;
            box.innerHTML += `<div class="msg user"><b>T√∫:</b> ${p}</div>`;
            document.getElementById("inputChat").value = "";
            
            setTimeout(() => {
                let r = "No tengo archivos suficientes para responder eso.";
                if(p.toLowerCase().includes("test")) r = "¬°Claro! Generando test de los temas seleccionados bas√°ndome en tu Drive...";
                box.innerHTML += `<div class="msg ia"><b>IA:</b> ${r}</div>`;
            }, 1000);
        };
    </script>
    <style>
        :root { --p: #2563eb; }
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f4f7f6; }
        header { background: white; padding: 10px 5%; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .view { display: none; flex-direction: column; align-items: center; }
        .grid-temas { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; width: 100%; }
        .card-tema { background: white; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card-tema.selected { border-color: var(--p); background: #eef2ff; }
        .card-tema.check { border-left: 5px solid #10b981; }
        .btn { background: var(--p); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        #chatLateral { width: 300px; background: white; border-left: 1px solid #ddd; display: none; flex-direction: column; }
        #chatBox { flex: 1; padding: 15px; overflow-y: auto; }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 5px; font-size: 0.9rem; }
        .ia { background: #f0fdf4; } .user { background: #eff6ff; text-align: right; }
    </style>
</head>
<body>

<header>
    <h2>OposTest IA</h2>
    <span id="txtOposHeader"></span>
    <div id="navApp" style="display:none; gap:10px;">
        <button onclick="mostrarVista('vistaPanel')">Temario</button>
        <button onclick="mostrarVista('vistaBiblioteca')">Drive</button>
        <button onclick="irASeleccion()">Cambiar Opos</button>
    </div>
</header>

<div class="main-layout">
    <div class="content">
        <div id="vistaLogin" class="view"><button class="btn" onclick="login()">Login Google</button></div>
        
        <div id="vistaSeleccion" class="view">
            <h3>Selecciona Oposici√≥n</h3>
            <button class="btn" onclick="seleccionarOposicion('TAI')">TAI</button>
            <button class="btn" onclick="seleccionarOposicion('AUX_ESTADO')" style="margin-top:10px;">AUX ESTADO</button>
        </div>

        <div id="vistaPanel" class="view">
            <div style="margin-bottom:20px;">
                <button class="btn" onclick="alert('Generando simulacro...')">üî• Simulacro Examen</button>
            </div>
            <div id="containerTemas" class="grid-temas"></div>
        </div>

        <div id="vistaBiblioteca" class="view">
            <div style="background:white; padding:20px; border-radius:10px;">
                <h3>Vincular PDF de Drive</h3>
                <select id="selectTemaDrive"></select>
                <input type="text" id="inputUrl" placeholder="Enlace de Drive">
                <button class="btn" onclick="vincularDrive()" style="width:100%">Vincular</button>
            </div>
        </div>
    </div>

    <div id="chatLateral">
        <div id="chatBox"></div>
        <div style="padding:10px; border-top:1px solid #eee;">
            <input type="text" id="inputChat" placeholder="Escribe..." style="width:70%;">
            <button onclick="enviarDuda()">></button>
        </div>
    </div>
</div>

</body>
</html>
