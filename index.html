<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OposTest IA - Auto-Configurable</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
            authDomain: "oposiciones-test.firebaseapp.com",
            projectId: "oposiciones-test",
            storageBucket: "oposiciones-test.firebasestorage.app",
            messagingSenderId: "116305102438",
            appId: "1:116305102438:web:25684cd6467f5a27398fa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Definici贸n Maestra de Oposiciones
        const oposData = {
            "TAI": { nombre: "T茅cnico Auxiliar Inform谩tica", temas: ["Tema 1: Constituci贸n", "Tema 2: Hardware", "Tema 3: Redes"] },
            "TAI_LIBRE": { nombre: "T茅cnico Auxiliar Inform谩tica", temas: ["Tema 1: Constituci贸n", "Tema 2: Hardware", "Tema 3: Redes"] },
            "AUX_ESTADO": { nombre: "Auxiliar Administrativo Estado", temas: ["Bloque I: Organizaci贸n", "Bloque II: Gesti贸n"] },
            "AUX_VALENCIA": { nombre: "Auxiliar Ayto. Valencia", temas: ["TEMA 1: Constituci贸n", "TEMA 2: Local"] }
        };

        let userActual = null;
        let oposSel = null;

        window.mostrarVista = (id) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            const target = document.getElementById(id);
            if(target) target.style.display = 'flex';
            
            // Navegaci贸n inteligente
            document.getElementById("navApp").style.display = (oposSel) ? "flex" : "none";
            document.getElementById("chatLateral").style.display = (oposSel) ? "flex" : "none";
        };

        // --- LGICA DE LOGIN Y AUTO-CREACIN ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userActual = user;
                console.log("Usuario logueado:", user.uid);
                
                const userRef = doc(db, "users", user.uid);
                const uDoc = await getDoc(userRef);

                if (!uDoc.exists()) {
                    // SI NO EXISTE, LO CREAMOS POR PRIMERA VEZ
                    console.log("Creando nuevo usuario en Firebase...");
                    await setDoc(userRef, {
                        uid: user.uid,
                        email: user.email,
                        nombre: user.displayName,
                        fechaCreacion: new Date(),
                        oposicion: null
                    });
                    mostrarVista('vistaSeleccion');
                } else {
                    // SI EXISTE, COMPROBAMOS SI YA TIENE OPOSICIN
                    const data = uDoc.data();
                    if (data.oposicion) {
                        window.seleccionarOposicion(data.oposicion);
                    } else {
                        mostrarVista('vistaSeleccion');
                    }
                }
            } else {
                mostrarVista('vistaLogin');
            }
        });

        window.login = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error en login:", error);
            }
        };

        window.seleccionarOposicion = async (key) => {
            // Normalizamos la clave por si viene con espacios o may煤sculas raras
            const cleanKey = key.trim();
            if (!oposData[cleanKey]) {
                console.warn("Clave no reconocida, usando TAI por defecto");
                oposSel = "TAI";
            } else {
                oposSel = cleanKey;
            }

            // Actualizar el perfil del usuario con la elecci贸n
            await setDoc(doc(db, "users", userActual.uid), { oposicion: oposSel }, { merge: true });
            
            document.getElementById("txtOposHeader").textContent = oposData[oposSel].nombre;
            renderTemario();
            mostrarVista('vistaPanel');
        };

        function renderTemario() {
            const grid = document.getElementById("containerTemas");
            const select = document.getElementById("selectTemaSubida");
            grid.innerHTML = ""; select.innerHTML = "";

            oposData[oposSel].temas.forEach(t => {
                const card = document.createElement("div");
                card.className = "card-tema";
                card.innerHTML = `<h4>${t}</h4><p>Estado: Sin test</p>`;
                grid.appendChild(card);

                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        // --- SUBIDA AUTOMTICA ---
        window.subirRecurso = async () => {
            const file = document.getElementById("fileInput").files[0];
            const tema = document.getElementById("selectTemaSubida").value;
            const btn = document.getElementById("btnSubir");
            if(!file) return alert("Selecciona un archivo PDF");

            btn.disabled = true; btn.innerText = "Subiendo...";

            try {
                // Ruta: /opo/UID/OPOSICION/nombre.pdf
                const storagePath = `opo/${userActual.uid}/${oposSel}/${file.name}`;
                const storageRef = ref(storage, storagePath);
                
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                // Guardamos la referencia en la colecci贸n 'recursos'
                await addDoc(collection(db, "recursos"), {
                    uid: userActual.uid,
                    oposicion: oposSel,
                    tema: tema,
                    nombreArchivo: file.name,
                    url: downloadURL,
                    fecha: new Date()
                });

                alert("Archivo " + file.name + " subido y asociado al " + tema);
                document.getElementById("fileInput").value = "";
            } catch (e) {
                console.error(e);
                alert("Error al subir archivo");
            } finally {
                btn.disabled = false; btn.innerText = "Subir PDF";
            }
        };

    </script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }
        header { background: white; padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; height: 60px; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .view { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 900px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; width: 100%; max-width: 400px; }
        .grid-temas { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; width: 100%; margin-top: 20px; }
        .card-tema { background: white; padding: 20px; border-radius: 12px; border-left: 5px solid var(--p); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn { background: var(--p); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-outline { background: white; border: 1px solid #ddd; color: #444; margin-top: 5px;}
        #chatLateral { width: 300px; background: white; border-left: 2px solid #e2e8f0; display: none; flex-direction: column; }
        select, input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <h2 style="color:var(--p); margin:0; cursor:pointer;" onclick="location.reload()">OposTest</h2>
        <span id="txtOposHeader" style="background:#e0e7ff; color:var(--p); padding:4px 12px; border-radius:15px; font-size:0.8rem; font-weight:bold;"></span>
    </div>
    <div id="navApp" style="display:none; gap:10px;">
        <button class="btn" style="width:auto;" onclick="mostrarVista('vistaPanel')">Inicio</button>
        <button class="btn btn-outline" style="width:auto;" onclick="mostrarVista('vistaBiblioteca')">Biblioteca</button>
        <button class="btn btn-outline" style="width:auto;" onclick="mostrarVista('vistaSeleccion')">Cambiar Opos</button>
    </div>
</header>

<div class="main-layout">
    <div class="content">
        <div id="vistaLogin" class="view">
            <div class="card">
                <h1>Acceso</h1>
                <p>Usa tu cuenta de Google para empezar</p>
                <button class="btn" onclick="login()">Entrar con Google</button>
            </div>
        </div>

        <div id="vistaSeleccion" class="view">
            <h2 style="margin-bottom:20px;">驴Qu茅 est谩s preparando?</h2>
            <div class="grid-temas">
                <div class="card-tema" style="cursor:pointer" onclick="seleccionarOposicion('TAI')"><h3>TAI Estado</h3></div>
                <div class="card-tema" style="cursor:pointer" onclick="seleccionarOposicion('AUX_ESTADO')"><h3>Auxiliar Estado</h3></div>
                <div class="card-tema" style="cursor:pointer" onclick="seleccionarOposicion('AUX_VALENCIA')"><h3>Ayto Valencia</h3></div>
            </div>
        </div>

        <div id="vistaPanel" class="view">
            <div style="width:100%; text-align:left;">
                <h3>Temario de Oposici贸n</h3>
                <div id="containerTemas" class="grid-temas"></div>
            </div>
        </div>

        <div id="vistaBiblioteca" class="view">
            <div class="card" style="max-width:500px;">
                <h3>Subir Material</h3>
                <label>Asociar al tema:</label>
                <select id="selectTemaSubida"></select>
                <input type="file" id="fileInput" accept=".pdf">
                <button id="btnSubir" class="btn" onclick="subirRecurso()">Subir PDF</button>
            </div>
        </div>
    </div>

    <div id="chatLateral">
        <div style="background:var(--p); color:white; padding:15px; font-weight:bold;"> Tutor IA</div>
        <div id="chatBox" style="flex:1; padding:15px; font-size:0.9rem; color:#666;">
            Bienvenido. Selecciona tus temas y sube tus apuntes para que pueda ayudarte a generar tests.
        </div>
    </div>
</div>

</body>
</html>
