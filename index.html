<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OposTest | Plataforma de Entrenamiento</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
            authDomain: "oposiciones-test.firebaseapp.com",
            projectId: "oposiciones-test",
            storageBucket: "oposiciones-test.firebasestorage.app",
            messagingSenderId: "116305102438",
            appId: "1:116305102438:web:25684cd6467f5a27398fa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables de Estado
        let userActual = null;
        let oposSel = null;
        let preguntasTest = [];
        let indicePregunta = 0;
        let respuestasUsuario = [];
        let tiempoRestante = 0;
        let intervaloTimer = null;
        let modoExamen = false;

        // --- NAVEGACIÓN ---
        window.mostrarVista = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userActual = user;
                document.getElementById("userName").textContent = user.displayName;
                mostrarVista('vistaSeleccion');
            } else {
                mostrarVista('vistaLogin');
            }
        });

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());

        // --- LÓGICA DE TEST ---
        window.seleccionarOposicion = (key) => {
            oposSel = key;
            document.getElementById("tituloOpos").textContent = "Preparando: " + key;
            mostrarVista('vistaConfig');
        };

        window.iniciarTest = async (simulacion) => {
            modoExamen = simulacion;
            const numPreguntas = document.getElementById("numPreguntas").value;
            
            // Aquí cargaríamos el JSON desde tu GitHub. 
            // Por ahora, simulamos carga de datos para que veas la estética:
            preguntasTest = [
                {pregunta: "¿Cuál es el puerto por defecto de HTTP?", opciones: ["21", "80", "443", "8080"], correcta: 1, explicacion: "HTTP usa el 80, HTTPS el 443."},
                {pregunta: "¿Qué protocolo se usa para enviar correos?", opciones: ["POP3", "IMAP", "SMTP", "FTP"], correcta: 2, explicacion: "SMTP es Simple Mail Transfer Protocol."},
                {pregunta: "¿Es Linux un sistema operativo monousuario?", opciones: ["Sí", "No", "Solo en servidores", "Depende de la distro"], correcta: 1, explicacion: "Linux es multiusuario y multitarea."}
            ];

            indicePregunta = 0;
            respuestasUsuario = [];
            tiempoRestante = modoExamen ? 3600 : 0; // 1 hora para examen
            
            renderPregunta();
            mostrarVista('vistaTest');
            iniciarTimer();
        };

        function iniciarTimer() {
            if (intervaloTimer) clearInterval(intervaloTimer);
            intervaloTimer = setInterval(() => {
                if (modoExamen) tiempoRestante--;
                else tiempoRestante++;
                
                let mins = Math.floor(Math.abs(tiempoRestante) / 60);
                let segs = Math.abs(tiempoRestante) % 60;
                document.getElementById("timer").textContent = `${mins}:${segs < 10 ? '0' : ''}${segs}`;
                
                if (modoExamen && tiempoRestante <= 0) finalizarTest();
            }, 1000);
        }

        function renderPregunta() {
            const p = preguntasTest[indicePregunta];
            document.getElementById("qText").textContent = (indicePregunta + 1) + ". " + p.pregunta;
            const opts = document.getElementById("qOptions");
            opts.innerHTML = "";
            
            p.opciones.forEach((opt, i) => {
                const btn = document.createElement("div");
                btn.className = "option-card";
                btn.textContent = opt;
                btn.onclick = () => seleccionarRespuesta(i);
                opts.appendChild(btn);
            });
        }

        function seleccionarRespuesta(i) {
            respuestasUsuario[indicePregunta] = i;
            if (indicePregunta < preguntasTest.length - 1) {
                indicePregunta++;
                renderPregunta();
            } else {
                finalizarTest();
            }
        }

        async function finalizarTest() {
            clearInterval(intervaloTimer);
            let aciertos = 0;
            preguntasTest.forEach((p, i) => {
                if (respuestasUsuario[i] === p.correcta) aciertos++;
            });

            const resultado = {
                fecha: new Date().toLocaleString(),
                oposicion: oposSel,
                aciertos: aciertos,
                total: preguntasTest.length,
                falladas: preguntasTest.length - aciertos
            };

            // Guardar en Firebase Results
            await addDoc(collection(db, "resultados"), {
                uid: userActual.uid,
                ...resultado
            });

            document.getElementById("resFinal").innerHTML = `
                <h2>Resultado: ${aciertos} / ${preguntasTest.length}</h2>
                <p>Oposición: ${oposSel}</p>
                <button class="btn" onclick="mostrarVista('vistaSeleccion')">Volver al Inicio</button>
            `;
            mostrarVista('vistaResultados');
        }

    </script>

    <style>
        :root { --blue: #003366; --orange: #ff9900; --light: #f8f9fa; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); color: var(--text); }
        
        /* Layout Estilo OposiTest */
        header { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; }
        .nav-links button { background: none; border: none; font-weight: bold; cursor: pointer; color: var(--blue); margin-left: 20px; }

        .view { display: none; max-width: 800px; margin: 40px auto; padding: 20px; }
        .view.active { display: block; }

        /* Tarjetas de Oposición */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .card { background: white; padding: 30px; border-radius: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer; transition: 0.3s; }
        .card:hover { border-color: var(--orange); transform: translateY(-5px); }

        /* Pantalla de Test */
        .test-header { display: flex; justify-content: space-between; background: var(--blue); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .option-card { background: white; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; }
        .option-card:hover { background: #fff5e6; border-color: var(--orange); }

        .btn { background: var(--orange); color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; }
        #timer { font-weight: bold; font-family: monospace; font-size: 20px; }
        
        #vistaLogin { text-align: center; margin-top: 100px; }
    </style>
</head>
<body>

<header>
    <div class="logo" style="font-size: 24px; font-weight: 900; color: var(--blue);">OPOS<span style="color:var(--orange)">TEST</span></div>
    <div id="userProfile" class="nav-links">
        <span id="userName"></span>
        <button onclick="mostrarVista('vistaResultados')">Mis Estadísticas</button>
        <button onclick="auth.signOut()">Salir</button>
    </div>
</header>

<div class="container">
    <div id="vistaLogin" class="view">
        <h1 style="font-size: 48px;">Tu plaza empieza aquí.</h1>
        <p>Accede para realizar simulacros y seguir tu progreso.</p>
        <button class="btn" onclick="login()" style="font-size: 18px; padding: 20px 40px;">Entrar con Google</button>
    </div>

    <div id="vistaSeleccion" class="view">
        <h2>Selecciona tu Oposición</h2>
        <div class="grid">
            <div class="card" onclick="seleccionarOposicion('TAI')"><h3>TAI</h3><p>Informática Estado</p></div>
            <div class="card" onclick="seleccionarOposicion('VALENCIA')"><h3>Ayto. Valencia</h3><p>Auxiliar Administrativo</p></div>
            <div class="card" onclick="seleccionarOposicion('ESTADO')"><h3>Estado C2</h3><p>Auxiliar Estado</p></div>
        </div>
    </div>

    <div id="vistaConfig" class="view">
        <h2 id="tituloOpos"></h2>
        <div style="background: white; padding: 30px; border-radius: 12px; border: 1px solid #ddd;">
            <label>Número de preguntas:</label><br>
            <select id="numPreguntas" style="width: 100%; padding: 10px; margin: 10px 0;">
                <option value="10">10 preguntas</option>
                <option value="20">20 preguntas</option>
                <option value="50">50 preguntas</option>
            </select>
            <br><br>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="iniciarTest(false)" style="background: #28a745;">MODO ENTRENAMIENTO</button>
                <button class="btn" onclick="iniciarTest(true)">MODO EXAMEN (Con tiempo)</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 15px;">* El modo examen no permite ver soluciones hasta el final.</p>
        </div>
    </div>

    <div id="vistaTest" class="view">
        <div class="test-header">
            <div id="timer">00:00</div>
            <div>Modo: <span id="modoDesc"></span></div>
        </div>
        <div id="qText" style="font-size: 20px; font-weight: bold; margin-bottom: 20px;"></div>
        <div id="qOptions"></div>
        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <button class="btn" style="background:#666" onclick="finalizarTest()">Finalizar</button>
        </div>
    </div>

    <div id="vistaResultados" class="view">
        <div id="resFinal" style="background: white; padding: 40px; border-radius: 12px; text-align: center;">
            </div>
    </div>
</div>

</body>
</html>
