<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Oposiciones Test</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// üîß CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
  authDomain: "oposiciones-test.firebaseapp.com",
  projectId: "oposiciones-test",
  storageBucket: "oposiciones-test.firebasestorage.app",
  messagingSenderId: "116305102438",
  appId: "1:116305102438:web:25684cd6467f5a27398fa7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let preguntasActuales = [];
let timerInterval = null;
let tiempoRestante = 0;
let seleccionOposicion = "";
let seleccionTema = "";
let registroRespuestas = []; // Para repaso

// üîê LOGIN GOOGLE
onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById("login").style.display="none";
    document.getElementById("usuario").textContent=user.displayName;
    document.getElementById("home").style.display="block";
  }
});

window.login = function(){
  const provider = new GoogleAuthProvider();
  signInWithPopup(auth, provider);
};

// üîπ Selecci√≥n de tema para pr√°ctica
window.seleccionarTema = function(opos, tema){
  seleccionOposicion = opos;
  seleccionTema = tema;
  document.getElementById("home").style.display="none";
  document.getElementById("configTest").style.display="block";
};

// üîπ Selecci√≥n de simulador de examen
window.simuladorExamen = function(opos){
  seleccionOposicion = opos;
  seleccionTema = "examen_simulado";
  document.getElementById("home").style.display="none";
  document.getElementById("configSimulacion").style.display="block";
};

// üîπ Empezar test normal desde configuraci√≥n
window.empezarTest = async function(){
  const cantidad = parseInt(document.getElementById("numPreguntas").value) || 5;
  const usarTemporizador = document.getElementById("activarTimer").checked;
  const minutos = parseInt(document.getElementById("tiempo").value) || 30;

  await cargarPreguntas(seleccionOposicion, seleccionTema, cantidad);

  document.getElementById("configTest").style.display="none";
  document.getElementById("testContainer").style.display="block";
  mostrarTest();

  if(usarTemporizador){
    tiempoRestante=minutos*60;
    iniciarTemporizador();
  }
};

// üîπ Configuraci√≥n simulador examen
window.iniciarSimulacion = async function(){
  const cantidad = parseInt(document.getElementById("numPreguntasSim").value) || 50;
  tiempoRestante = 90*60; // 90 minutos fijos

  await cargarPreguntas(seleccionOposicion, seleccionTema, cantidad);

  document.getElementById("configSimulacion").style.display="none";
  document.getElementById("testContainer").style.display="block";
  mostrarTest();
  iniciarTemporizador();
};

async function cargarPreguntas(opos, tema, cantidad){
  const q = query(
    collection(db,"questions"),
    where("oposicion","==",opos),
    where("tema","==",tema)
  );
  const snapshot = await getDocs(q);
  if(snapshot.empty){ alert("No hay preguntas disponibles"); return; }

  preguntasActuales=[];
  snapshot.forEach(doc=>preguntasActuales.push(doc.data()));
  preguntasActuales = preguntasActuales.sort(()=>0.5-Math.random()).slice(0,cantidad);
  registroRespuestas = preguntasActuales.map(p=>({pregunta:p.pregunta, correcta:p.correcta, seleccion:null}));
}

// üñ• Mostrar test
function mostrarTest(){
  const contenedor=document.getElementById("test");
  contenedor.innerHTML="";
  preguntasActuales.forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="pregunta";
    let html=`<p><strong>${i+1}. ${p.pregunta}</strong></p>`;
    p.opciones.forEach((op,idx)=>{
      html+=`<button class="opcion" data-index="${idx}" data-pregunta="${i}">${op}</button>`;
    });
    div.innerHTML=html;
    contenedor.appendChild(div);
  });

  const boton=document.createElement("button");
  boton.textContent="Corregir Test";
  boton.className="corregir";
  boton.onclick=corregirTest;
  contenedor.appendChild(boton);
}

// ‚úÖ Corregir test y guardar en Firestore para repaso
function corregirTest(){
  let aciertos=0;
  preguntasActuales.forEach((p,i)=>{
    const seleccion=document.querySelector(`.opcion[data-pregunta='${i}'].seleccionada`);
    registroRespuestas[i].seleccion = seleccion ? parseInt(seleccion.dataset.index) : null;
    if(seleccion && parseInt(seleccion.dataset.index)===p.correcta) aciertos++;
  });

  alert(`Resultado: ${aciertos} / ${preguntasActuales.length}`);

  guardarResultadosFirebase();
}

// üîπ Guardar resultados
async function guardarResultadosFirebase(){
  const user = auth.currentUser;
  if(!user) return;
  const ref = doc(db,"users",user.uid);
  const docSnap = await getDoc(ref);
  if(!docSnap.exists()){
    await setDoc(ref,{resultados:arrayUnion(...registroRespuestas)});
  } else {
    await updateDoc(ref,{resultados:arrayUnion(...registroRespuestas)});
  }
}

// üîπ Temporizador
function iniciarTemporizador(){
  document.getElementById("timer").textContent=formatTime(tiempoRestante);
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    tiempoRestante--;
    document.getElementById("timer").textContent=formatTime(tiempoRestante);
    if(tiempoRestante<=0){
      clearInterval(timerInterval);
      alert("Tiempo terminado, no puedes seguir el test");
      document.getElementById("testContainer").style.display="none";
      document.getElementById("home").style.display="block";
    }
  },1000);
}

window.pausarTemporizador = function(){
  if(timerInterval) clearInterval(timerInterval);
};
window.reanudarTemporizador = function(){
  iniciarTemporizador();
};

function formatTime(s){
  const m=Math.floor(s/60).toString().padStart(2,'0');
  const sec=(s%60).toString().padStart(2,'0');
  return `${m}:${sec}`;
}

// Selecci√≥n de opci√≥n
window.addEventListener("click",e=>{
  if(e.target.classList.contains("opcion")){
    const siblings=e.target.parentNode.querySelectorAll(".opcion");
    siblings.forEach(sib=>sib.classList.remove("seleccionada"));
    e.target.classList.add("seleccionada");
  }
});

// üîπ Volver al inicio
window.volverInicio = function(){
  document.getElementById("testContainer").style.display="none";
  document.getElementById("configTest").style.display="none";
  document.getElementById("configSimulacion").style.display="none";
  document.getElementById("home").style.display="block";
  if(timerInterval) clearInterval(timerInterval);
};

// üîπ Mostrar secci√≥n Recursos
window.mostrarRecursos = function(){
  alert("Aqu√≠ abriremos tus PDFs de recursos"); 
};

// üîπ Mostrar resultados
window.mostrarResultados = async function(){
  const user = auth.currentUser;
  if(!user) { alert("Inicia sesi√≥n"); return; }
  const ref = doc(db,"users",user.uid);
  const docSnap = await getDoc(ref);
  if(!docSnap.exists() || !docSnap.data().resultados){ alert("No hay resultados"); return; }
  const resultados = docSnap.data().resultados;
  let html="<h3>Resultados</h3>";
  resultados.forEach(r=>{
    html+=`<p>${r.pregunta}<br>Correcta: ${r.correcta} | Seleccionada: ${r.seleccion ?? "No respondida"}</p>`;
  });
  const cont=document.getElementById("test");
  document.getElementById("home").style.display="none";
  document.getElementById("configTest").style.display="none";
  document.getElementById("configSimulacion").style.display="none";
  document.getElementById("testContainer").style.display="block";
  cont.innerHTML=html;
};
</script>

<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f4f4;}
header{display:flex;justify-content:space-between;align-items:center;background:#2c3e50;color:white;padding:10px;}
header h1{margin:0;font-size:22px;}
.headerBtn{margin-right:10px;padding:5px 10px;background:#e67e22;color:white;border:none;border-radius:5px;cursor:pointer;}
#temas{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
#temas button{background:#3498db;color:white;flex:1 0 120px;padding:8px;border-radius:5px;cursor:pointer;}
#configTest, #configSimulacion, #testContainer, #home{padding:20px;}
#testContainer{margin-top:20px;background:white;padding:15px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
.pregunta{margin-bottom:15px;}
.opcion{display:block;width:100%;text-align:left;background:#ecf0f1;margin:3px 0;padding:5px;border-radius:4px;cursor:pointer;}
.opcion.seleccionada{background:#f1c40f;}
.corregir{background:#27ae60;color:white;margin-top:10px;padding:8px 15px;border:none;border-radius:5px;cursor:pointer;}
#timer{font-weight:bold;font-size:18px;margin:10px 0;color:#e74c3c;}
</style>

</head>
<body>

<header>
  <h1>Oposiciones Test</h1>
  <div>
    <button class="headerBtn" onclick="mostrarRecursos()">Recursos</button>
    <button class="headerBtn" onclick="volverInicio()">Home</button>
    <button class="headerBtn" onclick="mostrarResultados()">Resultados</button>
    <span id="usuario"></span>
    <button id="login" onclick="login()">Login Google</button>
  </div>
</header>

<!-- HOME -->
<div id="home" style="display:none;">
  <h2>Selecciona Oposici√≥n</h2>
  <select id="oposicion">
    <option value="TAI">T√©cnico Auxiliar de Inform√°tica</option>
    <option value="Administrativo">Administrativo</option>
  </select>

  <h3>Opciones</h3>
  <button onclick="simuladorExamen(document.getElementById('oposicion').value)">Simulador Examen</button>

  <h3>Selecciona tema</h3>
  <div id="temas">
    <button onclick="seleccionarTema('TAI','tema1')">Constituci√≥n Espa√±ola</button>
    <button onclick="seleccionarTema('TAI','tema2')">Administraci√≥n P√∫blica</button>
    <button onclick="seleccionarTema('TAI','tema3')">Seguridad Inform√°tica</button>
  </div>
</div>

<!-- CONFIGURACION TEST -->
<div id="configTest" style="display:none;">
  <h3>Configuraci√≥n del test</h3>
  <label>N√∫mero de preguntas:</label>
  <input type="number" id="numPreguntas" min="1" max="50" value="5"><br>
  <label>Temporizador (minutos):</label>
  <input type="number" id="tiempo" min="1" max="180" value="30">
  <label><input type="checkbox" id="activarTimer"> Activar temporizador</label>
  <br>
  <button onclick="empezarTest()">Iniciar Test</button>
</div>

<!-- CONFIGURACION SIMULACION -->
<div id="configSimulacion" style="display:none;">
  <h3>Simulador de examen (90 minutos)</h3>
  <label>N√∫mero de preguntas:</label>
  <input type="number" id="numPreguntasSim" min="1" max="100" value="50"><br>
  <button onclick="iniciarSimulacion()">Iniciar Examen</button>
</div>

<!-- TEST -->
<div id="testContainer" style="display:none;">
  <div id="timer"></div>
  <div id="test"></div>
  <button onclick="pausarTemporizador()">Pausar</button>
  <button onclick="reanudarTemporizador()">Reanudar</button>
</div>

</body>
</html>
