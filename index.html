<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OposTest IA - Sistema Restaurado</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
            authDomain: "oposiciones-test.firebaseapp.com",
            projectId: "oposiciones-test",
            storageBucket: "oposiciones-test.firebasestorage.app",
            messagingSenderId: "116305102438",
            appId: "1:116305102438:web:25684cd6467f5a27398fa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const oposicionesData = {
            "TAI_LIBRE": ["Tema 1: Constituci贸n", "Tema 2: Hardware", "Tema 3: Redes", "Tema 4: Seguridad"],
            "AUX_ESTADO": ["Bloque I: Organizaci贸n", "Bloque II: Gesti贸n", "Bloque III: Ofim谩tica"],
            "AUX_AYTO_VALENCIA": ["TEMA 1-4: Const.", "TEMA 5-10: Leyes", "TEMA 11-15: Local", "TEMA 16-21: Personal"]
        };

        let userActual = null;
        let oposicionSeleccionada = null;

        window.mostrarVista = (id) => {
            ["loginSection", "seleccionOposicion", "panelEstudio", "docSection"].forEach(v => {
                const el = document.getElementById(v);
                if(el) el.style.display = (v === id) ? "block" : "none";
            });
        };

        onAuthStateChanged(auth, async (user) => {
            if(user){
                userActual = user;
                document.getElementById("navUser").style.display = "flex";
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().oposicion) {
                    window.entrarOposicion(userDoc.data().oposicion);
                } else { mostrarVista('seleccionOposicion'); }
            } else { 
                mostrarVista('loginSection');
                document.getElementById("navUser").style.display = "none";
            }
        });

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());

        window.entrarOposicion = async (tipo) => {
            oposicionSeleccionada = tipo;
            if(userActual) await setDoc(doc(db, "users", userActual.uid), { oposicion: tipo }, { merge: true });
            document.getElementById("badgeOpos").textContent = tipo;
            document.getElementById("badgeOpos").style.display = "block";
            renderTemario();
            mostrarVista('panelEstudio');
        };

        function renderTemario() {
            const grid = document.getElementById("gridTemas");
            const select = document.getElementById("selectTemaUser");
            grid.innerHTML = ""; select.innerHTML = "";
            (oposicionesData[oposicionSeleccionada] || []).forEach(t => {
                grid.innerHTML += `<div class="card-tema">
                    <h4>${t}</h4>
                    <button class="btn-ia" onclick="alert('IA: Generando test de ' + '${t}')">Generar Test</button>
                </div>`;
                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        // Cargar Recursos desde Firebase (Academia)
        window.cargarRecursosAcademia = async () => {
            const lista = document.getElementById("listaMisTemas");
            lista.innerHTML = "Cargando recursos de Firebase...";
            const q = query(collection(db, "recursos"), where("oposicion", "==", oposicionSeleccionada));
            const snap = await getDocs(q);
            lista.innerHTML = "";
            snap.forEach(doc => {
                const data = doc.data();
                lista.innerHTML += `<div class="file-item"> ${data.nombre} <button onclick="window.open('${data.url}')">Descargar</button></div>`;
            });
        };
    </script>

    <style>
        :root { --blue: #1e40af; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); margin:0; }
        header { background: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; }
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        .view { display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card-tema { background: white; padding: 20px; border-radius: 12px; border-bottom: 4px solid var(--blue); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-ia { width: 100%; background: var(--blue); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .badge { background: var(--blue); color: white; padding: 5px 15px; border-radius: 20px; }
        .file-item { display: flex; justify-content: space-between; padding: 10px; background: white; margin-bottom: 5px; border-radius: 5px; border: 1px solid #eee; }
    </style>
</head>
<body>
    <header>
        <h1 onclick="mostrarVista('seleccionOposicion')" style="cursor:pointer">OposTest IA</h1>
        <div id="badgeOpos" class="badge" style="display:none"></div>
        <div id="navUser" style="display:none; gap:10px;">
            <button onclick="mostrarVista('docSection'); cargarRecursosAcademia();"> Biblioteca</button>
            <button onclick="mostrarVista('panelEstudio')">Inicio</button>
        </div>
    </header>

    <div class="container">
        <div id="loginSection" class="view" style="text-align:center;">
            <button onclick="login()" style="padding: 20px; margin-top: 50px; cursor:pointer;">Entrar con Google</button>
        </div>

        <div id="seleccionOposicion" class="view">
            <h2 style="text-align:center;">Elige tu Oposici贸n</h2>
            <div class="grid">
                <div class="card-tema" onclick="entrarOposicion('TAI_LIBRE')"><h3>TAI Estado</h3></div>
                <div class="card-tema" onclick="entrarOposicion('AUX_ESTADO')"><h3>Auxiliar Estado</h3></div>
                <div class="card-tema" onclick="entrarOposicion('AUX_AYTO_VALENCIA')"><h3>Ayto Valencia</h3></div>
            </div>
        </div>

        <div id="panelEstudio" class="view">
            <h2>Mis Temas</h2>
            <div id="gridTemas" class="grid"></div>
        </div>

        <div id="docSection" class="view">
            <h3> Biblioteca de PDF (desde Firebase)</h3>
            <div id="listaMisTemas"></div>
            <hr>
            <select id="selectTemaUser"></select>
            <input type="file" id="fileUser">
            <button class="btn-ia">Subir a mi nube</button>
        </div>
    </div>
</body>
</html>
