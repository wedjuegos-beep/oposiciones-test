<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OposTest IA - Sistema de Gestión</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, query, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVb6TjVzSy7Q1B1xoG_2F27C12x2GOS9Y",
            authDomain: "oposiciones-test.firebaseapp.com",
            projectId: "oposiciones-test",
            storageBucket: "oposiciones-test.firebasestorage.app",
            messagingSenderId: "116305102438",
            appId: "1:116305102438:web:25684cd6467f5a27398fa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // CLAVES CORREGIDAS (Deben coincidir con los botones)
        const oposData = {
            "TAI": { nombre: "Técnico Auxiliar Informática", temas: ["Tema 1", "Tema 2", "Tema 3"] },
            "AUX_ESTADO": { nombre: "Auxiliar Estado", temas: ["Bloque I", "Bloque II"] },
            "AUX_VALENCIA": { nombre: "Ayto Valencia", temas: ["Local", "General"] }
        };

        let userActual = null;
        let oposSel = null;

        // --- NAVEGACIÓN ---
        window.mostrarVista = (id) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        };

        // --- LOGIN ---
        onAuthStateChanged(auth, async (user) => {
            if(user){
                userActual = user;
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if(uDoc.exists() && uDoc.data().oposicion) {
                    window.seleccionarOposicion(uDoc.data().oposicion);
                } else { mostrarVista('vistaSeleccion'); }
            } else { mostrarVista('vistaLogin'); }
        });

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());

        // --- CORRECCIÓN ERROR 'nombre' ---
        window.seleccionarOposicion = async (key) => {
            if (!oposData[key]) {
                console.error("Clave de oposición no encontrada:", key);
                return;
            }
            oposSel = key;
            if(userActual) await setDoc(doc(db, "users", userActual.uid), { oposicion: key }, { merge: true });
            
            document.getElementById("txtOpos").textContent = oposData[key].nombre;
            renderTemarioSubida();
            mostrarVista('vistaPanel');
        };

        // --- GESTIÓN DE SUBIDA ---
        function renderTemarioSubida() {
            const select = document.getElementById("selectTemaSubida");
            select.innerHTML = "";
            oposData[oposSel].temas.forEach(t => {
                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        window.subirArchivo = async () => {
            const file = document.getElementById("inputPdf").files[0];
            const tema = document.getElementById("selectTemaSubida").value;
            const btn = document.getElementById("btnSubir");

            if(!file || !oposSel) return alert("Selecciona archivo y oposición");

            btn.disabled = true;
            btn.innerText = "Subiendo...";

            try {
                // 1. Subir a Storage: /opo/USER_ID/OPOSICION/nombre.pdf
                const rutaCarpeta = `opo/${userActual.uid}/${oposSel}/${file.name}`;
                const storageRef = ref(storage, rutaCarpeta);
                await uploadBytes(storageRef, file);
                const urlDescarga = await getDownloadURL(storageRef);

                // 2. Crear registro en Firestore (Colección 'recursos')
                await addDoc(collection(db, "recursos"), {
                    nombre: file.name,
                    tema: tema,
                    oposicion: oposSel,
                    url: urlDescarga,
                    ruta: `/opo/${userActual.uid}/${oposSel}`,
                    uid: userActual.uid,
                    fecha: new Date()
                });

                alert("¡Archivo vinculado correctamente!");
                document.getElementById("inputPdf").value = "";
            } catch (e) {
                console.error(e);
                alert("Error en la subida. Revisa las reglas de Storage.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Subir y Vincular";
            }
        };

    </script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; margin: 0; }
        .view { display: none; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 15px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 350px; }
        .btn { background: #1a73e8; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px;}
        .btn-opos { background: white; border: 2px solid #1a73e8; color: #1a73e8; margin-bottom: 10px; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
        header { background: white; padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center;}
    </style>
</head>
<body>

<header id="headerApp" style="display: none;">
    <strong>OposTest IA</strong>
    <span id="txtOpos" style="background: #e8f0fe; padding: 5px 10px; border-radius: 5px;"></span>
    <button onclick="mostrarVista('vistaSeleccion')">Cambiar</button>
</header>

<div id="vistaLogin" class="view" style="display: block;">
    <div class="card">
        <h2>Entrar</h2>
        <button class="btn" onclick="login()">Iniciar con Google</button>
    </div>
</div>

<div id="vistaSeleccion" class="view">
    <h2>Selecciona Oposición</h2>
    <div class="card">
        <button class="btn btn-opos" onclick="seleccionarOposicion('TAI')">TAI Estado</button>
        <button class="btn btn-opos" onclick="seleccionarOposicion('AUX_ESTADO')">Auxiliar Estado</button>
        <button class="btn btn-opos" onclick="seleccionarOposicion('AUX_VALENCIA')">Ayto Valencia</button>
    </div>
</div>

<div id="vistaPanel" class="view">
    <div class="card">
        <h3>Subir Temario</h3>
        <p>Los archivos se guardarán en tu nube de Firebase para generar tests.</p>
        
        <label>Selecciona Tema:</label>
        <select id="selectTemaSubida"></select>
        
        <input type="file" id="inputPdf" accept="application/pdf">
        
        <button id="btnSubir" class="btn" onclick="subirArchivo()">Subir y Vincular</button>
    </div>
</div>

<script>
    // Mostrar header solo si está logueado
    setInterval(() => {
        document.getElementById("headerApp").style.display = (window.oposSel) ? "flex" : "none";
    }, 1000);
</script>

</body>
</html>
